"use strict";var L=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var M=Object.getOwnPropertyNames;var O=Object.prototype.hasOwnProperty;var q=(t,e)=>{for(var s in e)L(t,s,{get:e[s],enumerable:!0})},j=(t,e,s,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of M(e))!O.call(t,n)&&n!==s&&L(t,n,{get:()=>e[n],enumerable:!(o=k(e,n))||o.enumerable});return t};var B=t=>j(L({},"__esModule",{value:!0}),t);var F={};q(F,{useChat:()=>K});module.exports=B(F);var i=require("react"),_=require("@vectara/stream-query-client");var P=async({filter:t,queryValue:e,language:s,summaryMode:o,rerank:n,rerankNumResults:T,rerankerId:p,rerankDiversityBias:h,hybridNumWords:S,hybridLambdaShort:c,hybridLambdaLong:D,summaryNumResults:l,summaryNumSentences:g,summaryPromptName:b,customerId:u,corpusId:R,endpoint:I,apiKey:E,chat:A})=>{let w=typeof e>"u"||e.trim().split(" ").length>S?D:c,C=R.split(",").map(a=>({customerId:u,corpusId:a,lexicalInterpolationConfig:{lambda:w},metadataFilter:t?`doc.source = '${t}'`:void 0})),d={query:[{query:e,start:0,numResults:n?T:10,corpusKey:C,contextConfig:{sentencesBefore:o?g:2,sentencesAfter:o?g:2,startTag:v,endTag:x},...o?{summary:[{responseLang:s,maxSummarizedResults:l,summarizerPromptName:b,chat:{store:!0,conversationId:A==null?void 0:A.conversationId}}]}:{},...n?{rerankingConfig:{rerankerId:p,...p===272725718?{mmrConfig:{diversityBias:h}}:{}}}:{}}]},N=`https://${I}/v1/query`,r=await fetch(N,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","customer-id":u,"x-api-key":E,"grpc-timeout":"60S","x-source":"react-chatbot"},body:JSON.stringify(d)});if(r.status!==200)throw new Error(r.status.toString());let m=await r.json(),f=m.responseSet[0].status;if(f.length>0&&f[0].code==="UNAUTHORIZED"&&console.log("UNAUTHORIZED access; check your API key and customer ID"),o){let a=m.responseSet[0].summary[0].status;if(a.length>0&&a[0].code==="BAD_REQUEST")throw new Error("BAD REQUEST: Too much text for the summarizer to summarize. Please try reducing the number of search results to summarize, or the context of each result by adjusting the 'summary_num_sentences', and 'summary_num_results' parameters respectively.");if(a.length>0&&a[0].code==="NOT_FOUND"&&a[0].statusDetail==="Failed to retrieve summarizer.")throw new Error(`BAD REQUEST: summarizer ${b} is invalid for this account.`)}return m.responseSet[0]},v="%START_SNIPPET%",x="%END_SNIPPET%";var U=t=>{if(!t)return;let e=[],{response:s,document:o}=t;return s.forEach(n=>{let{documentIndex:T,text:p}=n,{pre:h,post:S,text:c}=Q(p),D=o[Number(T)],{id:l,metadata:g}=D,{source:b,url:u,title:R,metadata:I}=H(g);e.push({id:l,snippet:{pre:h,text:c,post:S},source:b,url:u,title:R,metadata:I})}),e},H=t=>{let e=G(t);return{source:e.source,url:e.url,title:e.title||"Untitled",metadata:e}},Q=t=>{let[e,s]=t.indexOf(v)!==-1?t.split(v):["",t],[o,n]=s.indexOf(x)!==-1?s.split(x):[s,""];return{pre:e,post:n,text:o}},G=t=>{let e={};return t.forEach(s=>{e[s.name]=s.value}),e};var K=(t,e,s,o=!0,n="eng")=>{let[T,p]=(0,i.useState)([]),h=(0,i.useRef)(""),[S,c]=(0,i.useState)(null),[D,l]=(0,i.useState)(!1),[g,b]=(0,i.useState)(!1),[u,R]=(0,i.useState)(null),[I,E]=(0,i.useState)(!1),A=async({query:d,isRetry:N=!1})=>{if(D)return;N&&E(!1),c(null),h.current=d,c({id:"placeholder-message-id",question:d,answer:"",results:[]});let y={filter:"",queryValue:d,rerank:!0,rerankNumResults:7,rerankerId:272725718,rerankDiversityBias:.3,customerId:t,corpusId:e.join(","),endpoint:"api.vectara.io",apiKey:s};if(l(!0),o)try{await(0,_.streamQuery)({...y,corpusIds:e,summaryNumResults:7,summaryNumSentences:3,summaryPromptName:"vectara-summary-ext-v1.2.0",language:n,chat:{store:!0,conversationId:u!=null?u:void 0}},r=>C(r))}catch(r){console.log("Summary error",r),l(!1),E(!0);return}else try{let r=await P({...y,hybridNumWords:2,hybridLambdaLong:0,hybridLambdaShort:.1,summaryMode:!0,summaryNumResults:7,summaryNumSentences:3,summaryPromptName:"vectara-summary-ext-v1.2.0",language:n,chat:{conversationId:u!=null?u:void 0}});R(r.summary[0].chat.conversationId),p(m=>{var f,a;return[...m,{id:r.summary[0].chat.turnId,question:h.current,answer:(f=r==null?void 0:r.summary[0].text)!=null?f:"",results:(a=U(r))!=null?a:[]}]}),c(null),l(!1)}catch(r){console.log("Summary error",r),E(!0),l(!1);return}},w=()=>{p([]),R(null)},C=({references:d,details:N,updatedText:y,isDone:r})=>{var f;y&&(b(!0),l(!1));let m=N==null?void 0:N.find(a=>a.type==="chat");m&&R((f=m.data.conversationId)!=null?f:null),r?b(!1):c(a=>{var z;return{id:m?m.data.turnId:"",question:h.current,answer:y!=null?y:"",results:[...(z=a==null?void 0:a.results)!=null?z:[],...d!=null?d:[]]}})};return(0,i.useEffect)(()=>{!g&&S&&(p([...T,S]),c(null))},[g]),{sendMessage:A,activeMessage:S,messageHistory:T,isLoading:D,isStreamingResponse:g,startNewConversation:w,hasError:I}};
