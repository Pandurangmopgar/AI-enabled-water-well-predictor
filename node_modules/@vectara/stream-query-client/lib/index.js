"use strict";var I=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var F=Object.getOwnPropertyNames;var M=Object.prototype.hasOwnProperty;var z=(e,t)=>{for(var r in t)I(e,r,{get:t[r],enumerable:!0})},G=(e,t,r,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of F(t))!M.call(e,s)&&s!==r&&I(e,s,{get:()=>t[s],enumerable:!(a=w(t,s))||a.enumerable});return e};var L=e=>G(I({},"__esModule",{value:!0}),e);var Y={};z(Y,{streamQuery:()=>B});module.exports=L(Y);var u="%START_SNIPPET%",i="%END_SNIPPET%";var k=e=>{if(!e)return;let t=[],{response:r,document:a}=e;return r.forEach(s=>{let{documentIndex:c,text:f}=s,{pre:C,post:l,text:m}=q(f),d=a[Number(c)],{id:p,metadata:y}=d,{source:S,url:h,title:g,metadata:x}=O(y);t.push({id:p,snippet:{pre:C,text:m,post:l},source:S,url:h,title:g,metadata:x})}),t},O=e=>{let t=K(e);return{source:t.source,url:t.url,title:t.title||"Untitled",metadata:t}},q=e=>{let[t,r]=e.indexOf(u)!==-1?e.split(u):["",e],[a,s]=r.indexOf(i)!==-1?r.split(i):[r,""];return{pre:t,post:s,text:a}},K=e=>{let t={};return e.forEach(r=>{t[r.name]=r.value}),t};var j="api.vectara.io",B=async(e,t)=>{var m,d,p,y,S,h,g,x;let r={"x-api-key":e.apiKey,"customer-id":e.customerId,"Content-Type":"application/json"},a=(m=e.lambda)!=null?m:.025;a>1?a=1:a<0&&(a=0);let s=e.corpusIds.map(D=>({customerId:e.customerId,corpusId:D,lexicalInterpolationConfig:{lambda:a},metadataFilter:e.filter?`doc.source = '${e.filter}'`:void 0})),c=e.rerank?{rerankingConfig:{rerankerId:e.rerankerId,...e.rerankerId===272725718?{mmrConfig:{diversityBias:e.rerankDiversityBias}}:{}}}:{},f=JSON.stringify({query:[{query:e.queryValue,start:0,numResults:e.rerank?e.rerankNumResults:10,corpusKey:s,contextConfig:{sentencesBefore:(d=e.summaryNumSentences)!=null?d:2,sentencesAfter:(p=e.summaryNumSentences)!=null?p:2,startTag:u,endTag:i},summary:[{responseLang:e.language,maxSummarizedResults:e.summaryNumResults,summarizerPromptName:e.summaryPromptName,factualConsistencyScore:(y=e.enableFactualConsistencyScore)!=null?y:!1,chat:{store:(h=(S=e.chat)==null?void 0:S.store)!=null?h:!1,conversationId:(g=e.chat)==null?void 0:g.conversationId}}],...c}]}),C=await J(r,f,(x=e.endpoint)!=null?x:j),l="";for await(let D of C)try{D.split(`
`).filter(b=>b!=="").forEach(b=>{var T,R,N,P;let n=JSON.parse(b);if(!n.result)return;let v=H(n.result),_=Q(n.result),o=null;[v,_].forEach(E=>{E&&(o=o!=null?o:[],o.push(E))});let A={references:(T=k(n.result.responseSet))!=null?T:null,details:o,updatedText:$(n.result,l),isDone:(N=(R=n.result.summary)==null?void 0:R.done)!=null?N:!1};l=(P=A.updatedText)!=null?P:"",t(A)})}catch{}},H=e=>!e.summary||!e.summary.chat?null:{type:"chat",data:{conversationId:e.summary.chat.conversationId,turnId:e.summary.chat.turnId}},Q=e=>!e.summary||!e.summary.factualConsistency?null:{type:"factualConsistency",data:{score:e.summary.factualConsistency.score}},$=(e,t)=>e.summary?`${t}${e.summary.text}`:null,J=async(e,t,r)=>{let a=await fetch(`https://${r}/v1/stream-query`,{method:"POST",headers:e,body:t});if(a.status!==200)throw new Error(a.status.toString());if(!a.body)throw new Error("Response body does not exist");return V(a.body)};async function*V(e){let t=e.getReader(),r=new TextDecoder;for(;;){let{value:a,done:s}=await t.read();if(s)break;yield r.decode(a,{stream:!0})}}
